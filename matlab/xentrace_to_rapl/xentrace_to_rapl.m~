clc
clear

energy_unit = 1/(2^16);     % RAPL specification for Intel i7-2600
cpu_frequency = 3.4*10^9;   % 3.4GHz for Intel i7-2600
resample_delta = 0.1;         % Granularity of the resampling (seconds)
pmc_to_plot = [1 4];      % PMCs to plot on the graphs


% Import data -------------------------------------------------------------
disp('- Import data');
rapl_struct = importdata('rapl.csv');
rapl_raw = rapl_struct.data;
pmc_struct = importdata('pmc.csv');
pmc_raw = pmc_struct.data;
wattsup_raw = importdata('wattsup-watts');


% Preprocessing -----------------------------------------------------------
disp('- Preprocessing');
% zero-tsc values
zero_tsc_rapl_bitmask = rapl_raw(:,1)==0;          % bitmask: valid TSC values
rapl_raw(zero_tsc_rapl_bitmask,:)=[];              % matrix filtered
zero_tsc_pmc_bitmask = pmc_raw(:,1)==0;            % bitmask: valid TSC values
pmc_raw(zero_tsc_pmc_bitmask,:)=[];                % matrix filtered

% Convert counters to the right unit
rapl_raw(:,[5 6 7 8])=energy_unit*rapl_raw(:,[5 6 7 8]);
rapl_raw(:,1)=rapl_raw(:,1)/cpu_frequency;
pmc_raw(:,1)=pmc_raw(:,1)/cpu_frequency;

% Time incremental wrt the first value
base_of_times = min(rapl_raw(1,1), pmc_raw(1,1));
rapl_raw(:,1)=rapl_raw(:,1)-base_of_times;
pmc_raw(:,1)=pmc_raw(:,1)-base_of_times;


% Grouping and conditioning -----------------------------------------------------------
disp('- Grouping and conditioning');
% Merge RAPL information gathered on all cores
rapl_pkg_all=rapl_raw(:,[1 5]); 
rapl_pkg_all(:,2)=rapl_pkg_all(:,2)-rapl_pkg_all(1,2);       % Incremental wrt the first value
rapl_pkg_ts=timeseries(rapl_pkg_all(:,2), rapl_pkg_all(:,1), 'Name', 'rapl_pkg');
rapl_pp0_all=rapl_raw(:,[1 5]); 
rapl_pp0_all(:,2)=rapl_pp0_all(:,2)-rapl_pp0_all(1,2);       % Incremental wrt the first value
rapl_pp0_ts=timeseries(rapl_pp0_all(:,2), rapl_pp0_all(:,1), 'Name', 'rapl_pp0');
rapl_pp1_all=rapl_raw(:,[1 5]); 
rapl_pp1_all(:,2)=rapl_pp1_all(:,2)-rapl_pp1_all(1,2);       % Incremental wrt the first value
rapl_pp1_ts=timeseries(rapl_pp1_all(:,2), rapl_pp1_all(:,1), 'Name', 'rapl_pp1');
rapl_dram_all=rapl_raw(:,[1 5]); 
rapl_dram_all(:,2)=rapl_dram_all(:,2)-rapl_dram_all(1,2);    % Incremental wrt the first value
rapl_dram_ts=timeseries(rapl_dram_all(:,2), rapl_dram_all(:,1), 'Name', 'rapl_dram');

% Resample all the timeseries
tests_length = min(length(wattsup_raw),length(unique(floor(rapl_raw(:,1)))));
rapl_pkg_ts_resample=resample(rapl_pkg_ts, 1:resample_delta:tests_length);
rapl_pp0_ts_resample=resample(rapl_pp0_ts, 1:resample_delta:tests_length);
rapl_pp1_ts_resample=resample(rapl_pp1_ts, 1:resample_delta:tests_length);
rapl_dram_ts_resample=resample(rapl_dram_ts, 1:resample_delta:tests_length);

% Uniform Wattsup measurements
wattsup_ts = timeseries(wattsup_raw,1:tests_length,'Name','wattsup');
wattsup_ts = setinterpmethod(wattsup_ts,'zoh');
wattsup_ts_resample=resample(wattsup_ts, 1:resample_delta:tests_length);

% Estimate power on the RAPL_PKG counter and resample
dt=diff(rapl_pkg_ts_resample.time);     % differential time
dE=diff(rapl_pkg_ts_resample.data);     % differential data
power=dE./dt;
power_pkg_ts_resample=timeseries([power' power(end)]', rapl_pkg_ts_resample.time, 'Name','power_pkg');  % remember to add an element in the last position


% Per-core information filtering ------------------------------------------
% Split measures per unique cores
disp('- Split measures per unique cores');
unique_core_ids = unique(rapl_raw(:,2))';    
i = 1;
for core_id = unique_core_ids
    core_bitmask = rapl_raw(:,2)== core_id;   % bitmask: core_id data
    counter_core(i).id = core_id;             % Counter wrt the first

    counter_core(i).pkg = rapl_raw(core_bitmask,[1 5]);  
    counter_core(i).pkg(:,2)=counter_core(i).pkg(:,2)-counter_core(i).pkg(1,2);       % Incremental wrt the first value
        
    counter_core(i).pp0 = rapl_raw(core_bitmask,[1 6]);
    counter_core(i).pp0(:,2)=counter_core(i).pp0(:,2)-counter_core(i).pp0(1,2);       % Incremental wrt the first value
    
    counter_core(i).pp1 = rapl_raw(core_bitmask,[1 7]);
    counter_core(i).pp1(:,2)=counter_core(i).pp1(:,2)-counter_core(i).pp1(1,2);       % Incremental wrt the first value
    
    counter_core(i).dram = rapl_raw(core_bitmask,[1 8]);
    counter_core(i).dram(:,2)=counter_core(i).dram(:,2)-counter_core(i).dram(1,2);    % Incremental wrt the first value

    i = i+1;
end


% Per-domain information filtering ----------------------------------------
% Split measures per unique domain
disp('- Split measures per unique domain');
unique_domain_ids = unique(pmc_raw(:,3))';
base=rapl_pkg_ts;
i = 1;
for domain_id = unique_domain_ids
    domain_bitmask = pmc_raw(:,3)== domain_id;   % bitmask: domain_id data
    counter_domain(i).id = domain_id;            % Counter wrt the first

    counter_domain(i).pmc(1).raw = pmc_raw(domain_bitmask,[1 5]);
    tmp1 = cumulate_and_resample(counter_domain(i).pmc(1).raw(:,1), counter_domain(i).pmc(1).raw(:,2), 1, resample_delta, tests_length, bas);
    [base tmp1] = synchronize(base,tmp1,'Union');
    counter_domain(i).pmc(1).cum_ts = tmp1;

    counter_domain(i).pmc(2).raw = pmc_raw(domain_bitmask,[1 6]);
    tmp2 = cumulate_and_resample(counter_domain(i).pmc(2).raw(:,1), counter_domain(i).pmc(2).raw(:,2), 1, resample_delta, tests_length);
    [base tmp2] = synchronize(base,tmp2,'Union');
    counter_domain(i).pmc(2).cum_ts = tmp2;

    counter_domain(i).pmc(3).raw = pmc_raw(domain_bitmask,[1 7]);
    tmp3 = cumulate_and_resample(counter_domain(i).pmc(3).raw(:,1), counter_domain(i).pmc(3).raw(:,2), 1, resample_delta, tests_length);
    [base tmp3] = synchronize(base,tmp3,'Union');
    counter_domain(i).pmc(3).cum_ts = tmp3;

    counter_domain(i).pmc(4).raw = pmc_raw(domain_bitmask,[1 8]);
    tmp4 = cumulate_and_resample(counter_domain(i).pmc(4).raw(:,1), counter_domain(i).pmc(4).raw(:,2), 1, resample_delta, tests_length);
    [base tmp4] = synchronize(base,tmp4,'Union');
    counter_domain(i).pmc(4).cum_ts = tmp4;
    
    i = i+1;
end

% Plot Package Energy and Power, measured with RAPL and with the Watts Up Power meter
disp('- Plot Package Energy and Power, measured with RAPL and with the Watts Up Power meter');
figure;
hold on;
[hAx,hLine1,hLine2] = plotyy(rapl_pkg_ts_resample.time, rapl_pkg_ts_resample.data, [power_pkg_ts_resample.time, wattsup_ts_resample.time], [power_pkg_ts_resample.data, wattsup_ts_resample.data]);
xlabel('Time (s)');
ylabel(hAx(1),'Energy (J)');    % left y-axis
ylabel(hAx(2),'Power (W)');     % right y-axis
legend('Package Energy (RAPL)','Package Power (RAPL)','Workstation Power (external)');
grid on;
grid minor;
hold off;

% Plot Package Energy and Power (RAPL), with PMCi for every domain
disp('- Plot Package Energy and Power (RAPL), with PMCi for every domain');
figure;
total_plots = 1+length(unique_domain_ids);

subplot(total_plots,1,1);
plot_energy_and_power(rapl_pkg_ts_resample.time, rapl_pkg_ts_resample.data, power_pkg_ts_resample.time, power_pkg_ts_resample.data);

i = 1;
for domain_id = unique_domain_ids
    subplot(total_plots,1,i+1);
    hold on;
    j=1;
    for current_pmc = pmc_to_plot
        plot(counter_domain(i).pmc(current_pmc).cum_ts.time, counter_domain(i).pmc(current_pmc).cum_ts.data, '-');
        legend_index=j;
        legendInfo{legend_index} = ['dom-' int2str(counter_domain(i).id) '-pmc' int2str(current_pmc)];
        j=j+1;
    end
    title(['PMCs of dom-' int2str(counter_domain(i).id)]);
    legend(legendInfo);
    xlabel('Time (s)');
    ylabel('PMC value');
    grid on;
    grid minor;
    hold off;
    i = i+1;
end



%{   
% Plot PMC logs on different domains wrt RAPL
disp('- Plot PMC logs on different domains wrt RAPL');

figure;
subplot(2,1,1);

hold on;
[hAx,hLine1,hLine2] = plotyy(rapl_pkg_ts.time, rapl_pkg_ts.data, wattsup_ts.time, wattsup_ts.data);
xlabel('Time (s)');
ylabel(hAx(1),'RAPL counters');    % left y-axis
ylabel(hAx(2),'Watts Up (W)');     % right y-axis
hold off;

subplot(2,1,2);               % The first subplot is for RAPL
hold on;
i = 1;
for domain_id = unique_domain_ids
 
    plot(counter_domain(i).pmc1(:,1), counter_domain(i).pmc1(:,2), '-');
    % plot(counter_domain(i).pmc2(:,1),counter_domain(i).pmc2(:,2), '-');
    % plot(counter_domain(i).pmc3(:,1),counter_domain(i).pmc3(:,2), '-');
    % plot(counter_domain(i).pmc4(:,1),counter_domain(i).pmc4(:,2), '-');
    legendInfo{i} = ['dom-' int2str(counter_domain(i).id)];
    i = i+1;
end

legend(legendInfo);
xlabel('Time (s)');
ylabel('PMC Counter');
hold off;
%}

%{
% Plot RAPL logs on different cores
disp('- Plot RAPL logs on different cores');
figure;
i = 1;
for core_id = unique_core_ids
    subplot(2,2,i);
    hold on;
    plot(counter_core(i).pkg(:,1), counter_core(i).pkg(:,2), '.');
    plot(counter_core(i).pp0(:,1),counter_core(i).pp0(:,2), '.');
    plot(counter_core(i).pp1(:,1),counter_core(i).pp1(:,2), '.');
    plot(counter_core(i).dram(:,1),counter_core(i).dram(:,2), '.');
    title(['xarc1-core ' int2str(counter_core(i).id)]);
    legend('pkg','pp0','pp1','dram');
    xlabel('Time (s)');
    ylabel('RAPL Counter');
    hold off;
    i = i+1;
end

% Plot RAPL deltas on different cores
disp('- Plot RAPL deltas on different cores');
figure;
i = 1;
for core_id = unique_core_ids
    subplot(2,2,i);
    hold on;
    legend('pkg','pp0','pp1','dram');
    xlabel('Time (s)');
    ylabel('RAPL Counter');
    hold off;
    i = i+1;
end
%}

%{
% Plot PMC logs on different domains
disp('- Plot PMC logs on different domains');
figure;
domains_count = length(unique_domain_ids);
i = 1;
for domain_id = unique_domain_ids
    subplot(domains_count,1,i);
    hold on;
    plot(counter_domain(i).pmc1(:,1), counter_domain(i).pmc1(:,2), '-');
    plot(counter_domain(i).pmc2(:,1),counter_domain(i).pmc2(:,2), '-');
    plot(counter_domain(i).pmc3(:,1),counter_domain(i).pmc3(:,2), '-');
    plot(counter_domain(i).pmc4(:,1),counter_domain(i).pmc4(:,2), '-');
    title(['xarc1-domain ' int2str(counter_domain(i).id)]);
    legend('pmc1','pmc2','pmc3','pmc4');
    xlabel('Time (s)');
    ylabel('PMC Counter');
    hold off;
    i = i+1;
end
%}
